<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="toy.recipit.mapper.RecipeMapper">

    <select id="getPopularRecipes" parameterType="map" resultType="toy.recipit.mapper.vo.PopularRecipeVo">
        SELECT
            R.RECIPE_NO AS recipeNo,
            R.TITLE     AS title,
            IMG.URL     AS imagePath,
            SUM(CASE WHEN L.LIKE_YN = 'Y' THEN 1 ELSE 0 END) AS likeCount,
            MAX(CASE WHEN L.USER_NO = #{userNo} AND L.LIKE_YN = 'Y' THEN 1 ELSE 0 END) AS isLiked
        FROM RC_WEEKLY W
                 INNER JOIN RC_RECIPE R
                            ON W.RECIPE_NO = R.RECIPE_NO
                 INNER JOIN RC_IMAGE IMG
                           ON R.RECIPE_NO = IMG.RECIPE_NO
                           AND IMG.TYPE_CODE = #{imageTypeCode}
                 LEFT JOIN RC_LIKE L
                           ON R.RECIPE_NO = L.RECIPE_NO
        WHERE W.RECOMMENDED_DATE = CURDATE()
        GROUP BY R.RECIPE_NO
        ORDER BY W.SORT_SEQUENCE
        LIMIT #{size}
    </select>


</mapper>